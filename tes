-- =============================================================
-- LOGIKA AUTO FISHING (GLOBAL SCOPE)
-- =============================================================

-- 🔥 VARIABEL PENTING (DIKONTROL OLEH RAYFIELD SLIDER/TOGGLE) 🔥
local ToolSlot = 1
local BiteDelay = 1.0 
local CastingX, CastingY = -1.233184814453125, 0.04706447494934768

local running = false          -- Status ON/OFF AutoFish
local currentAutoFishThread = nil -- Thread untuk AutoFish

local autoSellRunning = false  -- Status ON/OFF AutoSell
local autoSellThread = nil     -- Thread untuk AutoSell
local SellInterval = 5         -- Default 5 Menit (untuk Auto Sell)

-- =============================================================
-- DATA LOKASI TELEPORT
-- =============================================================
local TeleportData = {
    ["Weather Machine"] = Vector3.new(-1471, -3, 1929),
    ["Esoteric Depths"] = Vector3.new(3157, -1303, 1439),
    ["Tropical Grove"] = Vector3.new(-2038, 3, 3650),
    ["Stingray Shores"] = Vector3.new(-32, 4, 2773),
    ["Kohana Volcano"] = Vector3.new(-519, 24, 189),
    ["Coral Reefs"] = Vector3.new(-3095, 1, 2177),
    ["Crater Island"] = Vector3.new(968, 1, 4854),
    ["Kohana"] = Vector3.new(-658, 3, 719),
    ["Winter Fest"] = Vector3.new(1611, 4, 3280),
    ["Isoteric Island"] = Vector3.new(1987, 4, 1400),
    ["Treasure Hall"] = Vector3.new(-3600, -267, -1558),
    ["Lost Shore"] = Vector3.new(-3663, 38, -989 ),
    ["Sishypus Statue"] = Vector3.new(-3792, -135, -986)
}
local TeleportLocations = {}
for name, _ in pairs(TeleportData) do
    table.insert(TeleportLocations, name)
end
table.sort(TeleportLocations)
local CurrentTeleportLocation = TeleportLocations[1] 

-- ========== SERVICE & REMOTE SETUP ==========
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local NetService = ReplicatedStorage:FindFirstChild("Packages", true)
 and ReplicatedStorage.Packages:FindFirstChild("_Index", true)
 and ReplicatedStorage.Packages._Index:FindFirstChild("sleitnick_net@0.2.0", true)
 and ReplicatedStorage.Packages._Index["sleitnick_net@0.2.0"]:FindFirstChild("net", true)

if not NetService then
 warn("❌ NetService tidak ditemukan. Logika memancing/menjual mungkin nonaktif.")
end

local function GetRemote(name)
    -- Menggunakan Wait per Remote agar lebih aman
    return NetService and NetService:WaitForChild(name, 5) 
end

local EquipToolEvent = GetRemote("RE/EquipToolFromHotbar")
local ChargeRodFunc = GetRemote("RF/ChargeFishingRod")
local RequestMinigameFunc = GetRemote("RF/RequestFishingMinigameStarted")
local FishingCompletedEvent = GetRemote("RE/FishingCompleted")
local CancelInputsFunc = GetRemote("RF/CancelFishingInputs")
local SellAllItemsFunc = GetRemote("RF/SellAllItems") 

-- UTILITY
local PERFECT_POWER = 1.0
local TIMING_LOCK_DELAY = 0.01

local function wait(time)
    if time then task.wait(time) end
end

-- ========== CORE GLOBAL FUNCTIONS ==========

function _G.EquipRod(slot)
    if EquipToolEvent then EquipToolEvent:FireServer(slot) end
 task.wait(0.01)
end

function _G.ChargeRod()
    if not ChargeRodFunc then return false end
 local ok = pcall(function()
  return ChargeRodFunc:InvokeServer()
 end)
 return ok
end

function _G.CastAndReel()
    if not RequestMinigameFunc or not FishingCompletedEvent then return false end

 local currentTime = tick()
 local args = {CastingY, PERFECT_POWER, currentTime} -- Argumen (Y-Pos, Power, Timestamp)
 local cast_success = false
 
 local charge_success = _G.ChargeRod()
 
 if charge_success then
  task.wait(TIMING_LOCK_DELAY)
  
  local success, result = pcall(function()
   return RequestMinigameFunc:InvokeServer(unpack(args))
  end)

  if success and (result == true or type(result) == "table") then
   cast_success = true
  end
 end

 if cast_success then
  task.wait(BiteDelay) 
  FishingCompletedEvent:FireServer()
  
  task.wait(0.005) 
        if CancelInputsFunc then pcall(function() CancelInputsFunc:InvokeServer() end) end
  _G.EquipRod(ToolSlot)
  return true
 end
 return false
end

function _G.AutoFishLoop()
    _G.EquipRod(ToolSlot)
    task.wait(1) 

    while running do
        local ok = _G.CastAndReel()
        if not ok then
            task.wait(0.05) 
        end
    end
    currentAutoFishThread = nil 
end

function _G.PerformAutoSell()
    if not SellAllItemsFunc then return end
    pcall(function() return SellAllItemsFunc:InvokeServer() end)
end

function _G.AutoSellLoop()
    while autoSellRunning do
        _G.PerformAutoSell()
        local waitTime = SellInterval * 60 
        task.wait(waitTime)
    end
    autoSellThread = nil
end

local function ToggleNameVisibility(hide)
    local LocalPlayer = game.Players.LocalPlayer
    local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    
    local Head = Character:FindFirstChild("Head")
    local NameTag = Head and Head:FindFirstChildOfClass("BillboardGui")
    
    if NameTag and NameTag:FindFirstChildOfClass("TextLabel") then
        local NameLabel = NameTag:FindFirstChildOfClass("TextLabel")
        NameLabel.TextTransparency = hide and 1 or 0 
    elseif NameTag then
        NameTag.Enabled = not hide
    end
end


-- =============================================================
-- UI RAYFIELD & INTEGRASI
-- =============================================================
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "Fish It Instant | Final",
   LoadingTitle = "Fish It Instant Script",
   LoadingSubtitle = "by Rafaczx",
   ConfigurationSaving = { Enabled = true, FolderName = "FishItInstant", FileName = "FishItConfig" },
   Discord = { Enabled = false, Invite = "", RememberJoins = true },
   KeySystem = false,
   KeySettings = { Title = "Sirius Key System", Subtitle = "Key System", Note = "Hubungi Rafaczx untuk mendapatkan kunci!", FileName = "SiriusKey", SaveKey = true, GrabKeyFromSite = false, Key = "" }
})

local TabFish = Window:CreateTab("Fishing Menu", 4483362458) 

-- 👻 TOGGLE HIDE NAME
TabFish:CreateToggle({
    Name = "👻 Hide My Name",
    CurrentValue = false,
    Callback = ToggleNameVisibility
})

-- 🎣 SLIDER DELAY MEMANCING
TabFish:CreateSlider({
    Name = "🎣 Bite Delay (Stabilitas)",
    CurrentValue = BiteDelay,
    Range = {0.5, 3.0}, 
    Increment = 0.05,
    Suffix = "s",
    Callback = function(value)
        BiteDelay = value
    end,
})

-- 🐟 TOGGLE AUTO FISH ON/OFF
TabFish:CreateToggle({
    Name = "Instant Fishing (Toggle)",
    CurrentValue = false,
    Callback = function(toggled)
        if not NetService then
            Rayfield:Notify({ Title = "Error", Content = "Remote Services tidak ditemukan.", Duration = 5 })
            return
        end

        if toggled then
            running = true
            currentAutoFishThread = task.spawn(_G.AutoFishLoop)
        else
            running = false
            if currentAutoFishThread and task.cancel then task.cancel(currentAutoFishThread) end
        end
    end,
})


local TabSell = Window:CreateTab("Sell Menu", 4483362458) 

-- 💰 SLIDER DELAY AUTO SELL
TabSell:CreateSlider({
    Name = "⏳ Jeda Auto Sell",
    CurrentValue = SellInterval,
    Range = {1, 60}, 
    Increment = 1,
    Suffix = " Menit",
    Callback = function(value)
        SellInterval = value 
    end,
})

-- 🛍️ TOGGLE AUTO SELL ON/OFF
TabSell:CreateToggle({
    Name = "Auto Sell Backpack (Toggle)",
    CurrentValue = false, 
    Callback = function(toggled)
        if not SellAllItemsFunc then
            Rayfield:Notify({ Title = "Error", Content = "Remote SellAllItems tidak ditemukan.", Duration = 5 })
            return
        end
        
        if toggled then
            autoSellRunning = true
            autoSellThread = task.spawn(_G.AutoSellLoop)
        else
            autoSellRunning = false
            if autoSellThread and task.cancel then task.cancel(autoSellThread) end
        end
    end
})

local TabTeleport = Window:CreateTab("Teleport Menu", 4483362458) 

-- 🗺️ DROPDOWN PILIH LOKASI
TabTeleport:CreateDropdown({
    Name = "Pilih Lokasi Teleport",
    Options = TeleportLocations,
    CurrentOption = TeleportLocations[1],
    Callback = function(choice)
        CurrentTeleportLocation = choice
    end,
})

-- ✈️ TOMBOL TELEPORT
TabTeleport:CreateButton({
    Name = "Teleport Ke Lokasi",
    Callback = function()
        local destinationVector = TeleportData[CurrentTeleportLocation]
        
        if not destinationVector then
            Rayfield:Notify({ Title = "Teleport Gagal", Content = "Koordinat tujuan tidak ditemukan.", Duration = 3 })
            return
        end

        local character = game.Players.LocalPlayer.Character
        local HRP = character and character:FindFirstChild("HumanoidRootPart")

        if HRP then
            -- Set CFrame ke posisi tujuan + sedikit offset Y (+3)
            local targetCFrame = CFrame.new(destinationVector) * CFrame.new(0, 3, 0) 
            
            local success = pcall(function()
                HRP.CFrame = targetCFrame
            end)

            if success then
                Rayfield:Notify({ Title = "Teleport Sukses!", Content = "Berpindah ke " .. CurrentTeleportLocation, Duration = 3 })
            else
                Rayfield:Notify({ Title = "Teleport Gagal", Content = "Gagal memindahkan karakter.", Duration = 3 })
            end
        else
            Rayfield:Notify({ Title = "Teleport Gagal", Content = "Karakter belum dimuat (HRP tidak ada).", Duration = 3 })
        end
    end,
})
